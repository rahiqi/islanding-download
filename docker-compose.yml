# Islanding Download Portal — run from repository root.
# Uses Redpanda (Kafka API–compatible) instead of Apache Kafka.
# The dispatcher image builds the React UI during docker build.

services:
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v24.3.5
    command: redpanda start --smp 1 --memory 1G --reserve-memory 0M --node-id 0 --check=false --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092 --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health --brokers 127.0.0.1:9092 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  redpanda-init:
    image: docker.redpanda.com/redpandadata/redpanda:v24.3.5
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for Redpanda..."
        until rpk cluster health --brokers redpanda:9092 2>/dev/null; do sleep 2; done
        rpk topic create download-queue --partitions 4 --brokers redpanda:9092 || true
        rpk topic create download-progress --partitions 4 --brokers redpanda:9092 || true
        rpk topic create agent-heartbeat --partitions 2 --brokers redpanda:9092 || true
        echo "Topics ready"
    depends_on:
      redpanda:
        condition: service_healthy
    restart: "no"

  dispatcher:
    build:
      context: .
      dockerfile: dispatcher/dispatcher/Dockerfile
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_URLS: http://+:8080
      Kafka__BootstrapServers: redpanda:9092
      KafkaConsumer__BootstrapServers: redpanda:9092
      AgentHeartbeat__BootstrapServers: redpanda:9092
    depends_on:
      redpanda-init:
        condition: service_completed_successfully

  agent:
    build:
      context: .
      dockerfile: agent/downloader-agent/Dockerfile
    environment:
      ASPNETCORE_URLS: http://+:8080
      DownloadWorker__BootstrapServers: redpanda:9092
      Heartbeat__BootstrapServers: redpanda:9092
    depends_on:
      redpanda-init:
        condition: service_completed_successfully
    deploy:
      replicas: 2
