# Islanding Download Portal — run from repository root.
# Uses Redpanda (Kafka API–compatible) instead of Apache Kafka.
# The dispatcher image builds the React UI during docker build.

volumes:
  redpanda-data:

services:
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v25.3.6
    command:
      - redpanda
      - start
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:19092
      - --rpc-addr
      - redpanda:33145
      - --advertise-rpc-addr
      - redpanda:33145
      - --mode
      - dev-container
      - --smp
      - "1"
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    ports:
      - "19092:19092"
      - "9644:9644"   # Redpanda Admin API (for Console)
    healthcheck:
      test: ["CMD-SHELL", "rpk topic list --brokers 127.0.0.1:9092 || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s

  redpanda-init:
    image: docker.redpanda.com/redpandadata/redpanda:v25.3.6
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for Redpanda..."
        until rpk topic list --brokers redpanda:9092 2>/dev/null; do sleep 2; done
        rpk topic create download-queue --partitions 4 --brokers redpanda:9092 || true
        rpk topic create download-progress --partitions 4 --brokers redpanda:9092 || true
        rpk topic create agent-heartbeat --partitions 2 --brokers redpanda:9092 || true
        echo "Topics ready"
    depends_on:
      redpanda:
        condition: service_healthy
    restart: "no"

  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:v3.5.1
    entrypoint: ["/bin/sh", "-c"]
    command:
      - 'echo "$$CONSOLE_CONFIG_FILE" > /tmp/config.yml && /app/console'
    environment:
      CONFIG_FILEPATH: /tmp/config.yml
      CONSOLE_CONFIG_FILE: |
        kafka:
          brokers: ["redpanda:9092"]
        redpanda:
          adminApi:
            enabled: true
            urls: ["http://redpanda:9644"]
    ports:
      - "8082:8080"
    depends_on:
      redpanda:
        condition: service_healthy

  dispatcher:
    build:
      context: .
      dockerfile: dispatcher/dispatcher/Dockerfile
    ports:
      - "8084:8080"
    environment:
      ASPNETCORE_URLS: http://+:8080
      Kafka__BootstrapServers: redpanda:9092
      KafkaConsumer__BootstrapServers: redpanda:9092
      AgentHeartbeat__BootstrapServers: redpanda:9092
    depends_on:
      redpanda-init:
        condition: service_completed_successfully

  agent:
    build:
      context: .
      dockerfile: agent/downloader-agent/Dockerfile
    environment:
      ASPNETCORE_URLS: http://+:8080
      DownloadWorker__BootstrapServers: redpanda:9092
      Heartbeat__BootstrapServers: redpanda:9092
    depends_on:
      redpanda-init:
        condition: service_completed_successfully
    deploy:
      replicas: 2
